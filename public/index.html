<!doctype html>
<html>

<head>
    <title>Recoustify</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        #login,
        #loggedin,
        #songs-table {
            display: none;
        }

        #myProgress {
            width: 100%;
            background-color: grey;
            display: none;
        }

        #myBar {
            width: 1%;
            height: 10px;
            background-color: green;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="login">
            <h1>Log in</h1>
            <a href="/login" class="btn btn-primary">Log in with Spotify</a>
        </div>

        <div id="loggedin">
            <h1>Recoustify</h1>
            <div class="results" id='playlist-table'>
                <p>Your Playlists:</p>
                <table class="table table-striped table-bordered" id='playlists'>
                    <thead>
                        <tr>
                            <th style="width:5%"> # </th>
                            <th style="width: 78%"> Playlist name </th>
                            <th style="width: 10%"> Recoustify </th>
                            <th style="width: 7%"> Remix </th>
                        </tr>
                    </thead>
                    <tbody id="playlist-items"></tbody>
                </table>
            </div>
            <div class="results" id='songs-table'>
                <div id="myProgress">
                    <div id="myBar"></div>
                </div>
                <p id="playlist_title"></p>
                <table class="table table-striped table-bordered" id='songs'>
                    <thead>
                        <tr>
                            <th style="width:5%"> # </th>
                            <th style="width: 47%"> Original song name </th>
                            <th style="width: 48%"> Recoustified song name </th>
                        </tr>
                    </thead>
                    <tbody id="song-items"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>

        var access_token;
        var refresh_token;
        var error;
        var playlist_owners = [];
        var new_playlist_uris = [];
        var old_artists = [];
        const ACOUSTIC_MODE = 0;
        const REMIX_MODE = 1;

        function move() {
            var elem = document.getElementById("myBar");
            var width = 1;
            var id = setInterval(frame, 18);
            function frame() {
                if (width >= 100) {
                    clearInterval(id);
                } else {
                    width++;
                    elem.style.width = width + '%';
                }
            }
        }
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        function performSearch(query) {
            $.ajax({
                url: 'https://api.spotify.com/v1/search',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                data: {
                    q: query,
                    type: 'playlist',
                    limit: 5
                },
                success: function (response) {
                    response.playlists.items.forEach(appendToList)
                }
            });
        }

        function displayOrigTracks(user_id, playlist_id) {
            $.ajax({
                url: 'https://api.spotify.com/v1/users/' + user_id + '/playlists/' + playlist_id + '/tracks',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                data: {
                    'fields': 'items(track(name,href,uri,artists))'
                },
                success: function (response) {
                    populateSongTable(response.items);
                }
            });
        }

        function populateSongTable(data) {
            for (var i = 0; i < data.length; i++) {
                var table = document.getElementById("songs");
                var row = table.insertRow(-1);
                var rowNumber = row.insertCell(0);
                var title = row.insertCell(1);
                var new_title = row.insertCell(2);

                rowNumber.innerHTML = i + 1;
                title.innerHTML = "<a href=" + data[i].track.uri + ">" + data[i].track.name + "</a>";
                new_title.innerHTML = "<a href=" + data[i].track.uri + ">" + data[i].track.name + "</a>";
                new_playlist_uris.push(data[i].track.uri);
                old_artists.push(data[i].track.artists[0].name);
            }
        }

        function populateSongTableWithNewTracks(mode) {
            var table = document.getElementById("songs");
            var old_song_title;
            var new_song_info;
            for (var i = 1; i < table.rows.length; i++) {
                for (var j = 0; j < table.rows[0].cells.length; j++) {
                    if (j == 1) {
                        old_song_title = table.rows[i].cells[j].innerText;
                        searchForNewTrack(mode, old_song_title, i, false);
                    }
                }
            }

            $("#myProgress").hide();

            function searchForNewTrack(mode, old_song_title, row, allowCovers) {
                var modifier;
                if (mode == ACOUSTIC_MODE) {
                    modifier = 'acoustic';
                } else {
                    modifier = 'remix'
                }
                if (allowCovers) {
                    var query = old_song_title + ' ' + modifier
                } else {
                    var query = 'track:' + old_song_title + ' ' + modifier + ' artist:' + old_artists[row-1];
                }
                $.ajax({
                    url: 'https://api.spotify.com/v1/search',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    data: {
                        'q': query,
                        'type': 'track',
                        'limit': 1,
                    },
                    success: function (response) {
                        appendNewTrack(response.tracks.items, row);
                    }
                });
            }

            function appendNewTrack(data, row) {
                if (data[0]) {
                    table.rows[row].cells[2].innerHTML = "<a href=" + data[0].uri + ">" + data[0].name + "</a>"
                    new_playlist_uris[row] = data[0].uri;
                }
            }
        }

        function getUserPlaylists() {
            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                success: function (response) {
                    displayPlaylists(response.id);
                }
            });
        }

        function displayPlaylists(user_id) {
            $.ajax({
                url: 'https://api.spotify.com/v1/users/' + user_id + '/playlists',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                success: function (response) {
                    populatePlaylistTable(response.items);
                }
            });
        }

        function populatePlaylistTable(data) {
            for (var i = 0; i < data.length; i++) {
                var table = document.getElementById("playlists");
                var row = table.insertRow(-1);
                var rowNumber = row.insertCell(0);
                var title = row.insertCell(1);

                var acousticButton = document.createElement("input");
                acousticButton.setAttribute("type", "button");
                (function (i) {
                    acousticButton.addEventListener("click", function () {
                        acoustic(i, data[i].uri, data[i].name);
                    });
                })(i);
                var currentCell = row.insertCell(2);
                currentCell.appendChild(acousticButton);

                var remixButton = row.insertCell(3);
                playlist_owners.push(data[i].owner.id);
                rowNumber.innerHTML = i + 1;
                title.innerHTML = "<a href=" + data[i].uri + ">" + data[i].name + "</a>";
                remixButton.innerHTML = i + 1;
            }
        }

        function acoustic(num, playlist_uri, name) {
            var arr = playlist_uri.split(":");
            var playlist_id = arr[arr.length - 1];
            document.getElementById("playlist_title").innerHTML = name;
            displayOrigTracks(playlist_owners[num], playlist_id);
            $("#myProgress").show();
            move();
            setTimeout(function () { populateSongTableWithNewTracks(ACOUSTIC_MODE) }, 2000);//create checkbox for allowing covers
            $('#playlist-table').hide();
            $('#songs-table').show();
        }

        function initApp() {
            var params = getHashParams();
            access_token = params.access_token;
            refresh_token = params.refresh_token;
            error = params.error;

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {
                    $('#login').hide();
                    $('#loggedin').show();
                    getUserPlaylists();
                } else {
                    $('#login').show();
                    $('#loggedin').hide();
                }
            }
        }

        $(document).ready(function () {
            initApp();
        });
    </script>
</body>

</html>